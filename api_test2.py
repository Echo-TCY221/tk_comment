import json
import pprint
import sqlite3
import requests
import datetime

conn = sqlite3.connect('comment_data.db')
cursor = conn.cursor()
aweme_id_list = ['7305574235227819273', '7322625324271881523', '7339717741210782985', '7325286177152486683',
                 '7309416556931386674', '7384740029257600283', '7309041570550943026', '7317513586849418522',
                 '7288227411328584997', '7291194631679741245', '7297891409288351027', '7298995257264344358',
                 '7307898778558713098', '7284086171251019066', '7355761266394172682', '7303830491562511653',
                 '7308775394520468786', '7391790455094054182', '7382131729487711498', '7283827158135459132',
                 '7382850713535253786', '7323809305944149285', '7288218783053843772', '7297083698451680550',
                 '7312053811235802394', '7282740595859180856', '7304905263994195210', '7321638690231455014',
                 '7304102132146310437', '7349481433414618406', '7322349520346516746', '7326111859566759177',
                 '7208925139738578231', '7355127328478858546', '7074172863728717069', '7299314805494582566',
                 '7350606513662102822', '7308249225538604314', '7327600707454979365', '7365352653359975689',
                 '7301903585661570313', '7392068848117124390', '7298249274133990666', '7319059867598146866',
                 '7191723968896797989', '7389627618305379594', '7354685572679486770', '7316473881525521674',
                 '7333433292940758281', '7287155319388622117', '7303521253359390003', '7317167556228402469',
                 '7317876822203551026', '7306764940340219173', '7300501094365416741', '7380672602462883110',
                 '7383644503829122354', '7295618115407187237', '7283053744483274042', '7295996622624820489',
                 '7344968282622922034', '7331710750337010982', '7326426216754335013', '7318191730296114441',
                 '7325668714848718130', '7286429079690087738', '7296450513040608563', '7299735784846789939',
                 '7372016725753154825', '7320153544856751397', '7324193081765399845', '7318608292979248421',
                 '7329084828014497062', '7369393525030522162', '7371668884170001673', '7292330235020840202',
                 '7326000590708854067', '7284150139332152634', '7287451524521938236', '7323073873967205683',
                 '7315677458760617253', '7320512192116247858', '7307524360972160266', '7283754218417048887',
                 '7326741840345058597', '7369791440932621577', '7315954405340220699', '7321972303279967526',
                 '7292730947861089563', '7380224772384296243', '7339896086842150181', '7319487804709326131',
                 '7363151306736930085', '7290798784953568549', '7356417775046249778', '7340230608389491977',
                 '7307159496051264795', '7304563771471711498', '7326487733340310834', '7300747877368876339',
                 '7316814464693652786', '7310860412747140390', '7113169491214814494', '7284140247850487096',
                 '7288939541187022140', '7305317747708153114', '7392521668427648294', '7293805750927838502',
                 '7320866739489705242', '7284853567653989692', '7284140743575358777', '7289286344310934841']
aweme_id_list_1 = [7223681730291486013, 7278232197515971880]
url = "https://cn-sy-bgp-plustmp1.natfrp.cloud:36000/tk_comment"
# url = "http://192.168.1.7:8900/tk_comment"
# url = "http://127.0.0.1:8900/tk_comment"
for aweme_id in aweme_id_list_1:
    for page in range(1, 10):
        data_1 = {
            "aweme_id": int(aweme_id),
            "page": page
        }

        data = {
            "local_dict": json.dumps(data_1, ensure_ascii=False)
        }

        response = requests.post(url, data=data, verify=False)

        res_data = json.loads(response.text)['data']
        # for i in res_data:
        #     print(i)
        for res in res_data:
            aweme_id = res.get("aweme_id", '')  # 视频aweme_id
            user_cid = res.get('cid', '')
            user_text = res.get('text', '')  # 评论
            user_data = res.get('user', '')
            user_ip = res.get('ip_label', '')
            user_name = user_data.get('nickname', '')
            user_signature = user_data.get('signature', '')  # 签名
            user_uid = user_data.get('uid', '')
            user_page = user_data['avatar_larger'].get('url_list', ["https://www.douyin.com/"])[0]  # 头像链接
            sec_uid = user_data.get('sec_uid', '')
            user_home = f"https://www.douyin.com/user/{sec_uid}"  # 用户主页链接
            timestamp = res.get('create_time', '')
            dt_object = datetime.datetime.fromtimestamp(timestamp)
            text_create_time = dt_object.strftime('%Y-%m-%d %H:%M:%S')
            user_number = user_data.get('unique_id', '')  # 抖音号
            if user_number == '':
                user_number = user_data.get('short_id', '')
            value_list = [user_cid, user_text, user_ip, user_name, user_signature, user_uid, user_page, user_home,
                          text_create_time, user_number, aweme_id]
            value = tuple(value_list)
            # 插入数据
            sql_ = """INSERT INTO tk_comment (user_cid, user_text, user_ip, user_name, user_signature, user_uid, user_page, user_home, text_create_time, user_number, aweme_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)"""
            cursor.execute(sql_, value)
            # 提交更改
            conn.commit()
            print("插入成功一条数据...")
